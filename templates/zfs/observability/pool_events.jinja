{% extends "layout_main.jinja" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-page">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li class="flex items-center">
                <a href="/" class="text-primary-400 hover:text-primary-300 transition-colors">Home</a>
                <svg class="w-4 h-4 mx-2 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </li>
            <li class="flex items-center">
                <a href="/zfs/observability" class="text-primary-400 hover:text-primary-300 transition-colors">Observability</a>
                <svg class="w-4 h-4 mx-2 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </li>
            <li>
                <span class="text-text-primary font-medium">Pool Events</span>
            </li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-text-primary mb-2">Pool Events</h1>
            <p class="text-text-secondary">View and manage ZFS pool event logs</p>
        </div>
        <div class="flex gap-2">
            <a href="/zfs/observability/pool-events/download?{% if selected_pools %}pools={{ ','.join(selected_pools) }}&{% endif %}verbose={{ 'true' if verbose else 'false' }}" 
               class="btn-success flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download
            </a>
            <form method="post" action="/zfs/observability/pool-events/clear" onsubmit="return confirm('Clear all pool events?');">
                <button type="submit" class="btn-danger flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Clear All Events
                </button>
            </form>
        </div>
    </div>

    <!-- Warning Messages -->
    {% if errors %}
    <div class="bg-warning-900/30 border-l-4 border-warning-500 text-warning-400 px-4 py-3 rounded mb-6" role="alert">
        <div class="flex items-start">
            <svg class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                <strong class="font-semibold">Warning:</strong> Some pools could not be accessed:
                <ul class="list-disc ml-6 mt-2">
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    {% if request.query_params.get('message') %}
    <div class="bg-success-900/30 border-l-4 border-success-500 text-success-400 px-4 py-3 rounded mb-6" role="alert">
        <div class="flex items-start">
            <svg class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>{{ request.query_params.get('message') }}</span>
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="card mb-8">
        <div class="px-6 py-4 border-b border-border-subtle">
            <h2 class="text-lg font-semibold text-text-primary flex items-center gap-2">
                <svg class="w-5 h-5 text-info-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
                Filter Options
            </h2>
        </div>
        <div class="p-6">
            <form method="get" action="/zfs/observability/pool-events" id="eventsForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="form-label">Filter by Pools</label>
                        {% if all_pools %}
                        <div class="space-y-2 max-h-48 overflow-y-auto border border-border-default rounded-lg p-4 bg-bg-elevated-2">
                            {% for pool in all_pools %}
                            <label class="flex items-center cursor-pointer hover:bg-bg-elevated-3 p-2 rounded transition-colors">
                                <input type="checkbox" name="pool_check" value="{{ pool }}" 
                                    {% if pool in selected_pools %}checked{% endif %}
                                    class="form-checkbox"
                                    onchange="updatePoolsInput()">
                                <span class="ml-2 text-sm text-text-primary">{{ pool }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="pools" id="pools" value="{{ ','.join(selected_pools) if selected_pools else '' }}">
                        {% else %}
                        <p class="text-sm text-text-secondary py-4 text-center bg-bg-elevated-2 rounded-lg border border-border-default">No pools available</p>
                        {% endif %}
                    </div>
                    
                    <div class="space-y-4">
                        <div class="card-nested">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" name="verbose" value="true" {% if verbose %}checked{% endif %}
                                    class="form-checkbox">
                                <span class="ml-2 text-sm text-text-primary font-medium">Verbose output</span>
                            </label>
                            <p class="text-xs text-text-secondary mt-2 ml-6">Show full raw event data with detailed formatting</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="btn-primary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                        Apply Filters
                    </button>
                    <button type="button" onclick="selectAllPools()" class="btn-secondary">
                        Select All
                    </button>
                    <button type="button" onclick="deselectAllPools()" class="btn-secondary">
                        Deselect All
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function updatePoolsInput() {
            const checkboxes = document.querySelectorAll('input[name="pool_check"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            document.getElementById('pools').value = selected.join(',');
        }
        
        function selectAllPools() {
            const checkboxes = document.querySelectorAll('input[name="pool_check"]');
            checkboxes.forEach(cb => cb.checked = true);
            updatePoolsInput();
        }
        
        function deselectAllPools() {
            const checkboxes = document.querySelectorAll('input[name="pool_check"]');
            checkboxes.forEach(cb => cb.checked = false);
            updatePoolsInput();
        }
        
        // Initialize on page load
        updatePoolsInput();
    </script>

    <!-- Events organized by Pool -->
    <div class="card overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-border-subtle flex justify-between items-center">
            <h2 class="text-xl font-semibold text-text-primary">
                Pool Events 
                <span class="text-sm font-normal text-text-secondary ml-2">({{ total_events }} total events)</span>
            </h2>
            <div class="flex gap-2">
                <button onclick="expandAll()" class="btn-secondary text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                    </svg>
                    Expand All
                </button>
                <button onclick="collapseAll()" class="btn-secondary text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    Collapse All
                </button>
            </div>
        </div>
        
        {% if pool_events %}
            {% for pool_name, events in pool_events.items() %}
            <div class="border-b border-border-subtle last:border-b-0">
                <!-- Pool Header (Collapsible) -->
                <div class="px-6 py-4 bg-bg-elevated-2 cursor-pointer hover:bg-bg-elevated-3 flex justify-between items-center transition-colors"
                     onclick="togglePool('pool_{{ loop.index }}')">
                    <div class="flex items-center">
                        <svg id="icon_pool_{{ loop.index }}" class="w-5 h-5 mr-3 text-primary-400 transform transition-transform" 
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                        <h3 class="text-lg font-semibold text-primary-400">{{ pool_name }}</h3>
                    </div>
                    <span class="badge badge-info">{{ events|length }} events</span>
                </div>
                
                <!-- Pool Events Table (Collapsible Content) -->
                <div id="pool_{{ loop.index }}" class="overflow-x-auto">
                    {% if events %}
                        {% if verbose %}
                        <!-- Verbose mode: Display as formatted blocks -->
                        <div class="p-4 space-y-4">
                            {% for event in events %}
                            <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto border-l-4 
                                {% if 'error' in event.raw.lower() %}border-danger-500
                                {% elif 'warn' in event.raw.lower() %}border-warning-500
                                {% else %}border-primary-500{% endif %}">
                                <pre class="text-gray-100 text-xs font-mono whitespace-pre leading-relaxed m-0">{{ event.raw }}</pre>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <!-- Normal mode: Display as table -->
                        <table class="min-w-full divide-y divide-border-subtle">
                            <thead class="bg-bg-elevated-2">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Time</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Event Class</th>
                                </tr>
                            </thead>
                            <tbody class="bg-bg-elevated divide-y divide-border-subtle">
                                {% for event in events %}
                                <tr class="hover:bg-bg-elevated-2 transition-colors">
                                    <td class="px-4 py-3 text-sm text-text-primary whitespace-nowrap font-mono">
                                        {{ event.time }}
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <span class="badge 
                                            {% if 'error' in event.class.lower() %}badge-danger
                                            {% elif 'warn' in event.class.lower() %}badge-warning
                                            {% else %}badge-info{% endif %}">
                                            {{ event.class }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    {% else %}
                    <div class="p-8 text-center">
                        <svg class="w-12 h-12 mx-auto text-text-tertiary mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                        <p class="text-text-secondary">No events for this pool</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="p-12 text-center">
            <svg class="w-20 h-20 mx-auto text-text-tertiary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p class="text-text-secondary text-lg mb-2">No pool events available</p>
            <p class="text-text-tertiary text-sm">Events will appear here when ZFS operations occur</p>
        </div>
        {% endif %}
    </div>

    <script>
        function togglePool(poolId) {
            const content = document.getElementById(poolId);
            const icon = document.getElementById('icon_' + poolId);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }
        
        function expandAll() {
            const allContents = document.querySelectorAll('[id^="pool_"]');
            const allIcons = document.querySelectorAll('[id^="icon_pool_"]');
            
            allContents.forEach(content => {
                if (!content.id.startsWith('icon_')) {
                    content.style.display = 'block';
                }
            });
            
            allIcons.forEach(icon => {
                icon.style.transform = 'rotate(0deg)';
            });
        }
        
        function collapseAll() {
            const allContents = document.querySelectorAll('[id^="pool_"]');
            const allIcons = document.querySelectorAll('[id^="icon_pool_"]');
            
            allContents.forEach(content => {
                if (!content.id.startsWith('icon_')) {
                    content.style.display = 'none';
                }
            });
            
            allIcons.forEach(icon => {
                icon.style.transform = 'rotate(-90deg)';
            });
        }
    </script>

    <!-- Info Note -->
    <div class="card-nested bg-info-900/20 border-info-500/20">
        <div class="flex items-start">
            <svg class="w-5 h-5 text-info-400 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
                <p class="text-sm text-info-400"><strong>Note:</strong> Pool events are stored in kernel memory and persist across reboots only if saved. Use "Clear All Events" to remove all current events.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
