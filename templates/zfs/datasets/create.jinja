{% extends "layout.jinja" %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Breadcrumb Navigation -->
    <nav class="flex items-center text-sm text-text-secondary">
        <a href="/zfs/pools" class="hover:text-text-primary transition-colors">Pools</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <a href="/zfs/datasets" class="hover:text-text-primary transition-colors">Datasets</a>
        {% if pool %}
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="font-mono text-xs text-text-primary">{{ pool }}</span>
        {% endif %}
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="text-text-primary font-medium">Create</span>
    </nav>

    <!-- Page Header -->
    <div>
        <h1 class="text-3xl font-bold text-text-primary">Create ZFS Dataset</h1>
        <p class="text-text-secondary mt-1">
            {% if pool %}
            Create a new dataset in pool <span class="font-mono text-text-primary">{{ pool }}</span>
            {% else %}
            Create a new filesystem or volume dataset
            {% endif %}
        </p>
    </div>

    <!-- Error Message -->
    {% if error %}
        {% with message=error %}
            {% include "partials/error.jinja" %}
        {% endwith %}
    {% endif %}

    <!-- Create Form -->
    <div class="card">
        <div class="card-body">
            <form method="post" action="/zfs/datasets/create" class="space-y-6" x-data="{ 
                datasetType: '{{ dataset_type if dataset_type else 'filesystem' }}', 
                encryption: '{{ encryption if encryption else '' }}',
                parentDataset: '{{ parent if parent else (pool if pool else '') }}',
                datasetSuffix: '',
                get fullDatasetName() {
                    if (!this.parentDataset || !this.datasetSuffix) return '';
                    return this.parentDataset + '/' + this.datasetSuffix;
                },
                get isNameIncomplete() {
                    return !this.parentDataset || !this.datasetSuffix || this.datasetSuffix.includes('/');
                }
            }">
                <!-- Hidden field for the full dataset name (submitted to server) -->
                <input type="hidden" name="dataset_name" :value="fullDatasetName">
                
                <!-- Dataset Name - Two Part Input -->
                <div>
                    <label class="form-label">
                        Dataset Name <span class="text-danger-400">*</span>
                    </label>
                    
                    {% if pool and pool_datasets %}
                    <!-- Pool specified with datasets available - show dropdown -->
                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                            <select 
                                x-model="parentDataset"
                                class="form-select"
                            >
                                <option value="">Select parent dataset...</option>
                                {% for ds in pool_datasets %}
                                <option value="{{ ds.name }}" {% if ds.name == pool or ds.name == parent %}selected{% endif %}>{{ ds.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <span class="text-text-tertiary text-lg font-mono">/</span>
                        <div class="flex-1">
                            <input 
                                type="text" 
                                x-model="datasetSuffix"
                                :class="datasetSuffix && datasetSuffix.includes('/') ? 'form-input border-danger-500 ring-1 ring-danger-500' : 'form-input'"
                                placeholder="new_dataset_name"
                            >
                        </div>
                    </div>
                    <p class="text-sm mt-2 text-text-tertiary">
                        <span x-show="!isNameIncomplete" class="text-text-secondary">
                            Full path: <span class="font-mono text-text-primary" x-text="fullDatasetName"></span>
                        </span>
                        <span x-show="isNameIncomplete && !datasetSuffix" class="text-text-tertiary">
                            Select a parent dataset and enter a name for the new dataset
                        </span>
                        <span x-show="datasetSuffix && datasetSuffix.includes('/')" class="text-danger-400">
                            Dataset name cannot contain slashes - use the dropdown to select parent
                        </span>
                    </p>
                    {% elif pool %}
                    <!-- Pool specified but no datasets yet - show pool as prefix with text input -->
                    <div class="flex items-center gap-2">
                        <div class="bg-bg-elevated-2 px-3 py-2 rounded-lg border border-border-subtle">
                            <span class="font-mono text-text-primary">{{ pool }}</span>
                        </div>
                        <span class="text-text-tertiary text-lg font-mono">/</span>
                        <div class="flex-1">
                            <input 
                                type="text" 
                                x-model="datasetSuffix"
                                x-init="parentDataset = '{{ pool }}'"
                                :class="datasetSuffix && datasetSuffix.includes('/') ? 'form-input border-danger-500 ring-1 ring-danger-500' : 'form-input'"
                                placeholder="new_dataset_name"
                            >
                        </div>
                    </div>
                    <p class="text-sm mt-2 text-text-tertiary">
                        <span x-show="!isNameIncomplete" class="text-text-secondary">
                            Full path: <span class="font-mono text-text-primary" x-text="fullDatasetName"></span>
                        </span>
                        <span x-show="isNameIncomplete && !datasetSuffix" class="text-text-tertiary">
                            Enter a name for the new dataset in pool <span class="font-mono">{{ pool }}</span>
                        </span>
                        <span x-show="datasetSuffix && datasetSuffix.includes('/')" class="text-danger-400">
                            Dataset name cannot contain slashes
                        </span>
                    </p>
                    {% else %}
                    <!-- No pool specified - show full text input (legacy behavior) -->
                    <input 
                        type="text" 
                        x-model="parentDataset"
                        x-init="datasetSuffix = 'placeholder'"
                        class="form-input"
                        placeholder="e.g., tank/mydata or tank/storage/documents"
                    >
                    <!-- Override hidden field for legacy mode -->
                    <input type="hidden" name="dataset_name" :value="parentDataset" x-show="false">
                    <p class="text-text-tertiary text-sm mt-1">
                        Full path including pool name (e.g., poolname/dataset/subdataset)
                    </p>
                    <script>
                        // For legacy mode, we need to submit parentDataset directly
                        document.addEventListener('alpine:init', () => {
                            Alpine.data('legacyMode', () => ({
                                init() {
                                    this.$watch('parentDataset', value => {
                                        this.datasetSuffix = value ? 'set' : '';
                                    });
                                }
                            }));
                        });
                    </script>
                    {% endif %}
                </div>

                <!-- Dataset Type -->
                <div>
                    <label for="dataset_type" class="form-label">
                        Dataset Type <span class="text-danger-400">*</span>
                    </label>
                    <select 
                        id="dataset_type" 
                        name="dataset_type"
                        class="form-select"
                        x-model="datasetType"
                    >
                        <option value="filesystem">Filesystem</option>
                        <option value="volume">Volume (zvol)</option>
                    </select>
                    <p class="text-text-tertiary text-sm mt-1">
                        Filesystem for file storage, Volume for block devices
                    </p>
                </div>

                <!-- Volume Size (only for volumes) -->
                <div x-show="datasetType === 'volume'" x-transition>
                    <label for="volsize" class="form-label">
                        Volume Size <span class="text-danger-400">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="volsize" 
                        name="volsize"
                        class="form-input"
                        placeholder="e.g., 10G, 500M, 1T"
                        :required="datasetType === 'volume'"
                    >
                    <p class="text-text-tertiary text-sm mt-1">
                        Specify size with unit: K, M, G, T (e.g., 10G for 10 gigabytes)
                    </p>
                </div>

                <!-- Mountpoint (only for filesystems) -->
                <div x-show="datasetType === 'filesystem'" x-transition>
                    <label for="mountpoint" class="form-label">
                        Mountpoint
                    </label>
                    <input 
                        type="text" 
                        id="mountpoint" 
                        name="mountpoint" 
                        value="{{ mountpoint if mountpoint else '' }}"
                        class="form-input"
                        placeholder="Leave empty for automatic (e.g., /poolname/dataset)"
                    >
                    <p class="text-text-tertiary text-sm mt-1">
                        Custom mountpoint path, or leave empty to use default. Use 'none' to disable mounting.
                    </p>
                </div>

                <!-- Compression -->
                <div>
                    <label for="compression" class="form-label">
                        Compression
                    </label>
                    <select 
                        id="compression" 
                        name="compression"
                        class="form-select"
                    >
                        <option value="off" {% if compression == 'off' %}selected{% endif %}>Off</option>
                        <option value="lz4" {% if not compression or compression == 'lz4' %}selected{% endif %}>LZ4 (Recommended)</option>
                        <option value="gzip" {% if compression == 'gzip' %}selected{% endif %}>GZIP</option>
                        <option value="gzip-1" {% if compression == 'gzip-1' %}selected{% endif %}>GZIP-1 (Fastest)</option>
                        <option value="gzip-9" {% if compression == 'gzip-9' %}selected{% endif %}>GZIP-9 (Best)</option>
                        <option value="zstd" {% if compression == 'zstd' %}selected{% endif %}>ZSTD</option>
                        <option value="lzjb" {% if compression == 'lzjb' %}selected{% endif %}>LZJB (Legacy)</option>
                    </select>
                    <p class="text-text-tertiary text-sm mt-1">
                        LZ4 is recommended for best performance/compression balance
                    </p>
                </div>

                <!-- Record Size -->
                <div>
                    <label for="recordsize" class="form-label">
                        Record Size
                    </label>
                    <select 
                        id="recordsize" 
                        name="recordsize"
                        class="form-select"
                    >
                        <option value="">Default (128K)</option>
                        <option value="4K" {% if recordsize == '4K' %}selected{% endif %}>4K (Database)</option>
                        <option value="8K" {% if recordsize == '8K' %}selected{% endif %}>8K (Database)</option>
                        <option value="16K" {% if recordsize == '16K' %}selected{% endif %}>16K (Small files)</option>
                        <option value="32K" {% if recordsize == '32K' %}selected{% endif %}>32K</option>
                        <option value="64K" {% if recordsize == '64K' %}selected{% endif %}>64K</option>
                        <option value="128K" {% if recordsize == '128K' %}selected{% endif %}>128K (Default)</option>
                        <option value="256K" {% if recordsize == '256K' %}selected{% endif %}>256K</option>
                        <option value="512K" {% if recordsize == '512K' %}selected{% endif %}>512K (Large files)</option>
                        <option value="1M" {% if recordsize == '1M' %}selected{% endif %}>1M (Large files)</option>
                    </select>
                    <p class="text-text-tertiary text-sm mt-1">
                        Smaller recordsize (4K-16K) for databases, larger (256K-1M) for large sequential files
                    </p>
                </div>

                <!-- ATime -->
                <div>
                    <label for="atime" class="form-label">
                        Access Time Updates (atime)
                    </label>
                    <select 
                        id="atime" 
                        name="atime"
                        class="form-select"
                    >
                        <option value="off" {% if not atime or atime == 'off' %}selected{% endif %}>Off (Recommended)</option>
                        <option value="on" {% if atime == 'on' %}selected{% endif %}>On</option>
                    </select>
                    <p class="text-text-tertiary text-sm mt-1">
                        <strong>Off is recommended:</strong> Disabling atime improves performance by not writing to disk on every file read. 
                        Enable atime only if you need to track when files were last accessed (e.g., for compliance, backup software that relies on access times, or mail servers).
                    </p>
                </div>

                <!-- Encryption -->
                <div>
                    <label for="encryption" class="form-label">
                        Encryption
                    </label>
                    <select 
                        id="encryption" 
                        name="encryption"
                        class="form-select"
                        x-model="encryption"
                    >
                        <option value="">Off (No Encryption)</option>
                        <option value="aes-256-gcm">AES-256-GCM (Recommended)</option>
                        <option value="aes-128-gcm">AES-128-GCM</option>
                        <option value="aes-192-gcm">AES-192-GCM</option>
                        <option value="aes-256-ccm">AES-256-CCM</option>
                        <option value="aes-128-ccm">AES-128-CCM</option>
                        <option value="aes-192-ccm">AES-192-CCM</option>
                    </select>
                    <p class="text-text-tertiary text-sm mt-1">
                        Enable native ZFS encryption. AES-256-GCM provides the best security and performance.
                    </p>
                </div>

                <!-- Encryption Passphrase (only when encryption is enabled) -->
                <div x-show="encryption !== ''" x-transition class="space-y-4">
                    <div>
                        <label for="passphrase" class="form-label">
                            Encryption Passphrase <span class="text-danger-400">*</span>
                        </label>
                        <input 
                            type="password" 
                            id="passphrase" 
                            name="passphrase"
                            class="form-input"
                            placeholder="Enter a strong passphrase"
                            :required="encryption !== ''"
                        >
                        <p class="text-text-tertiary text-sm mt-1">
                            This passphrase will be required to unlock the dataset after system reboot.
                        </p>
                    </div>

                    <div>
                        <label for="passphrase_confirm" class="form-label">
                            Confirm Passphrase <span class="text-danger-400">*</span>
                        </label>
                        <input 
                            type="password" 
                            id="passphrase_confirm" 
                            name="passphrase_confirm"
                            class="form-input"
                            placeholder="Re-enter passphrase"
                            :required="encryption !== ''"
                        >
                    </div>

                    <!-- Info box about keyfile -->
                    <div class="card-nested bg-info-900/20 border-info-700">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-info-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <div>
                                <h4 class="text-sm font-semibold text-info-400 mb-1">Keyfile Support</h4>
                                <p class="text-sm text-text-secondary">
                                    To use a keyfile instead of a passphrase, you can change the key format from the command line after creation using: 
                                    <code class="bg-bg-tertiary px-1 py-0.5 rounded text-xs">zfs change-key -o keyformat=raw -o keylocation=file:///path/to/keyfile dataset-name</code>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Options Section -->
                <div class="border-t border-border-subtle pt-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-2">Additional Options</h3>
                    <p class="text-text-secondary text-sm">
                        More properties can be configured after creation via the properties page.
                    </p>
                </div>

                <!-- Warning Box -->
                <div class="card-nested bg-warning-900/20 border-warning-700">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-warning-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <h3 class="text-sm font-semibold text-warning-400 mb-2">Important Notes:</h3>
                            <ul class="list-disc list-inside space-y-1 text-sm text-text-secondary">
                                <li>Dataset names must be unique within the pool</li>
                                <li>Parent datasets must exist (or will be created automatically)</li>
                                <li>Volumes (zvols) require a size specification</li>
                                <li>Properties can be changed after creation</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 pt-4">
                    <a href="/zfs/datasets" class="btn-secondary">
                        Cancel
                    </a>
                    <button 
                        type="submit" 
                        class="inline-flex items-center gap-2 htmx-loading font-medium py-2 px-4 rounded-lg transition-colors"
                        :class="isNameIncomplete ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'btn-success'"
                        :disabled="isNameIncomplete"
                    >
                        <span class="htmx-indicator">
                            <div class="loading-spinner loading-spinner-sm"></div>
                        </span>
                        <span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </span>
                        <span>Create Dataset</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
