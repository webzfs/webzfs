{% extends "layout.jinja" %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center text-sm text-text-secondary">
        <a href="/zfs/pools" class="hover:text-text-primary transition-colors">Pools</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="text-text-primary font-medium">{{ pool.name }}</span>
    </nav>

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-text-primary">Pool: {{ pool.name }}</h1>
            <p class="text-text-secondary mt-1">View pool status and manage operations</p>
        </div>
        <div class="flex gap-2">
            <a href="/zfs/pools/{{ pool.name }}/properties" class="btn-primary inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Properties
            </a>
            <a href="/zfs/pools/{{ pool.name }}/history" class="btn-secondary inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                History
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    {% if request.query_params.get('message') %}
        {% with message=request.query_params.get('message') %}
            {% include "partials/success.jinja" %}
        {% endwith %}
    {% endif %}
    
    {% if request.query_params.get('error') %}
        {% with message=request.query_params.get('error') %}
            {% include "partials/error.jinja" %}
        {% endwith %}
    {% endif %}

    <!-- Pool Status -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Status Output -->
        <div class="card col-span-2">
            <div class="card-body">
                <h2 class="text-xl font-semibold text-text-primary mb-4">Pool Status</h2>
                <pre class="bg-bg-elevated-2 text-text-primary p-4 rounded-lg overflow-x-auto text-sm font-mono border border-border-subtle">{{ pool.status_output }}</pre>
            </div>
        </div>

        <!-- Key Properties -->
        <div class="card">
            <div class="card-body">
                <h2 class="text-xl font-semibold text-text-primary mb-4">Key Properties</h2>
                <div class="space-y-3">
                    {% if pool.properties %}
                        {% for prop_name in ['size', 'capacity', 'allocated', 'free', 'fragmentation', 'health', 'version', 'bootfs', 'delegation', 'autoreplace', 'failmode', 'autoexpand'] %}
                            {% if pool.properties.get(prop_name) %}
                            <div class="flex justify-between border-b border-border-subtle pb-2">
                                <span class="text-text-secondary text-sm">{{ prop_name }}:</span>
                                <span class="text-text-primary font-mono text-sm">{{ pool.properties[prop_name].value }}</span>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                    <p class="text-text-tertiary">No properties available</p>
                    {% endif %}
                </div>
                <div class="mt-4">
                    <a href="/zfs/pools/{{ pool.name }}/properties" class="text-primary-400 hover:text-primary-300 text-sm inline-flex items-center gap-1 transition-colors">
                        <span>View All Properties</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <div class="card-body">
                <h2 class="text-xl font-semibold text-text-primary mb-4">Actions</h2>
                <div class="space-y-3">
                    <!-- Scrub -->
                    <form method="post" action="/zfs/pools/{{ pool.name }}/scrub" id="form-scrub-start">
                        <button type="button"
                                class="btn-warning w-full inline-flex items-center justify-center gap-2"
                                onclick="showConfirm('confirm-scrub-start')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Start Scrub
                        </button>
                    </form>
                    
                    <form method="post" action="/zfs/pools/{{ pool.name }}/scrub/stop" id="form-scrub-stop">
                        <button type="button"
                                class="btn-secondary w-full inline-flex items-center justify-center gap-2"
                                onclick="showConfirm('confirm-scrub-stop')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Stop Scrub
                        </button>
                    </form>
                    
                    {% if checkpoint_supported %}
                    <!-- Checkpoint - only show create button if no checkpoint exists -->
                    {% if not checkpoint_info or not checkpoint_info.exists %}
                    <form method="post" action="/zfs/pools/{{ pool.name }}/checkpoint" id="form-checkpoint-create">
                        <button type="button"
                                class="btn-warning w-full inline-flex items-center justify-center gap-2"
                                onclick="showConfirm('confirm-checkpoint-create')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                            </svg>
                            Create Checkpoint
                        </button>
                    </form>
                    {% endif %}
                    {% endif %}
                    
                    <!-- Export -->
                    <a href="/zfs/pools/{{ pool.name }}/export/confirm" 
                       class="btn-danger w-full inline-flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Export Pool
                    </a>
                    
                    <!-- Info Note -->
                    <div class="card-nested">
                        <p class="text-xs text-text-tertiary flex items-start gap-2">
                            <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span><strong class="text-text-secondary">Note:</strong> Pool destruction must be performed via command line for safety.</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkpoint Card - Only shown if a checkpoint exists -->
    {% if checkpoint_supported and checkpoint_info and checkpoint_info.exists %}
    <div class="card">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-warning-900/50 rounded-lg">
                    <svg class="w-6 h-6 text-warning-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-text-primary">Pool Checkpoint</h2>
                    <p class="text-text-secondary text-sm">A checkpoint is currently active for this pool</p>
                </div>
            </div>
            
            <div class="space-y-4">
                <!-- Checkpoint Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card-nested">
                        <div class="text-text-tertiary text-xs uppercase mb-1">Created</div>
                        <div class="text-text-primary font-mono text-sm">{{ checkpoint_info.creation_time or 'Unknown' }}</div>
                    </div>
                    {% if checkpoint_info.space_used %}
                    <div class="card-nested">
                        <div class="text-text-tertiary text-xs uppercase mb-1">Space Consumed</div>
                        <div class="text-text-primary font-mono text-sm">{{ checkpoint_info.space_used }}</div>
                    </div>
                    {% endif %}
                </div>
                
                {% if checkpoint_info.status_line %}
                <div class="card-nested">
                    <div class="text-text-tertiary text-xs uppercase mb-1">Status</div>
                    <div class="text-text-primary font-mono text-sm">{{ checkpoint_info.status_line }}</div>
                </div>
                {% endif %}
                
                <!-- Rollback Instructions -->
                <div class="card-nested bg-warning-900/20 border-warning-900">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-warning-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <div>
                            <strong class="text-warning-400 block mb-2">Rollback to Checkpoint</strong>
                            <p class="text-text-secondary text-sm mb-3">
                                To roll back this pool to the checkpoint state, you must run the following commands at the CLI. 
                                <strong class="text-danger-400">This is a destructive operation</strong> - all changes made to the pool 
                                since the checkpoint was created will be permanently lost.
                            </p>
                            <pre class="bg-bg-elevated-2 text-text-primary p-3 rounded-lg text-sm font-mono border border-border-subtle overflow-x-auto">zpool export {{ pool.name }}
zpool import --rewind-to-checkpoint {{ pool.name }}</pre>
                        </div>
                    </div>
                </div>
                
                <!-- Discard Checkpoint Button -->
                <form method="post" action="/zfs/pools/{{ pool.name }}/checkpoint/discard" id="form-checkpoint-discard">
                    <button type="button"
                            class="btn-danger w-full inline-flex items-center justify-center gap-2"
                            onclick="showConfirm('confirm-checkpoint-discard')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Discard Checkpoint
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div>
        <a href="/zfs/pools" class="text-text-secondary hover:text-text-primary inline-flex items-center gap-2 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Pools
        </a>
    </div>
</div>

<!-- Confirmation Modals -->
{% set id = 'confirm-scrub-start' %}
{% set title = 'Start Pool Scrub' %}
{% set message = 'Start scrub on ' ~ pool.name ~ '? This operation will scan all data to verify integrity and may take a while depending on pool size.' %}
{% set confirm_text = 'Start Scrub' %}
{% set confirm_class = 'warning' %}
{% set confirm_action = 'document.getElementById("form-scrub-start").submit()' %}
{% include 'partials/confirm.jinja' %}

{% set id = 'confirm-scrub-stop' %}
{% set title = 'Stop Pool Scrub' %}
{% set message = 'Stop the currently running scrub on ' ~ pool.name ~ '?' %}
{% set confirm_text = 'Stop Scrub' %}
{% set confirm_class = 'warning' %}
{% set confirm_action = 'document.getElementById("form-scrub-stop").submit()' %}
{% include 'partials/confirm.jinja' %}

{% if checkpoint_supported %}
{% set id = 'confirm-checkpoint-create' %}
{% set title = 'Create Pool Checkpoint' %}
{% set message = 'Create a checkpoint for pool <strong>' ~ pool.name ~ '</strong>?<br><br>A checkpoint captures the entire state of the pool at the current moment. You can later rewind the pool to this checkpoint state if needed.<br><br><strong>Note:</strong> Only one checkpoint can exist at a time. Creating a checkpoint will consume additional space as data changes.' %}
{% set confirm_text = 'Create Checkpoint' %}
{% set confirm_class = 'warning' %}
{% set confirm_action = 'document.getElementById("form-checkpoint-create").submit()' %}
{% include 'partials/confirm.jinja' %}

{% set id = 'confirm-checkpoint-discard' %}
{% set title = 'Discard Pool Checkpoint' %}
{% set message = 'Discard the checkpoint for pool <strong>' ~ pool.name ~ '</strong>?<br><br><strong class="text-danger-400">Warning:</strong> This action cannot be undone. Once the checkpoint is discarded, you will no longer be able to rewind the pool to the checkpoint state. The space consumed by the checkpoint will be released.' %}
{% set confirm_text = 'Discard Checkpoint' %}
{% set confirm_class = 'danger' %}
{% set confirm_action = 'document.getElementById("form-checkpoint-discard").submit()' %}
{% include 'partials/confirm.jinja' %}
{% endif %}

<script>
// Ensure showConfirm function is available
window.showConfirm = function(dialogId) {
    const dialog = document.getElementById(dialogId);
    
    if (!dialog) {
        console.error('Dialog not found:', dialogId);
        return;
    }
    
    // Try using Alpine's global Alpine object if available
    if (window.Alpine) {
        // Use Alpine.$data to access the component's data
        const component = window.Alpine.$data(dialog);
        if (component) {
            component.open = true;
            return;
        }
    }
    
    // Fallback to __x property
    if (dialog.__x) {
        dialog.__x.$data.open = true;
        return;
    }
    
    // If neither works, try dispatching an event
    dialog.dispatchEvent(new CustomEvent('open-modal'));
    console.warn('Could not open modal using Alpine.js, tried dispatching event');
};
</script>

{% endblock %}
